<!DOCTYPE html>
    <html lang="en">
        <head>
            <meta charset="utf-8">
            <title>D3: All vehicles</title>
            <script type="text/javascript" src="../d3-book/d3.js"></script>
            <style type="text/css">
            
              h1 {
                font-family: Helvetica, sans-serif;
                font-size: 14px;
                font-weight: bold;
              }

              .area {
                stroke: none;
              }

              .area:hover {
                fill: yellow;
              }
            </style>
        </head>
        <body>
            <h1>Monthly Number of Electric-Drive Vehicles Sold in the U.S.: January 2005&ndash;February 2017</h1>
            <script type="text/javascript">
            
              var w = 1400;
              var h = 300;
              var padding = 20;

              var dataset, xScale, yScale, xAxis, yAxis, area;

              var parseTime = d3.timeParse("%Y-%m");

              var formatTime = d3.timeFormat("%b %Y");

              var vehicleStack = d3.stack();
              var typeStack = d3.stack();

              d3.request("vehicle_sales_data.csv")
                .mimeType("text/csv")
                .get(function(response) {

                  // DATA PARSING

                  var rows = d3.csvParseRows(response.responseText);

                  dataset = [];

                  for (var i = 3; i < rows.length; i++) {

                    dataset[i - 3] = {
                      date: parseTime(rows[i][0])
                    };

                    for (var j = 1; j < rows[i].length; j++) {

                      var make       = rows[0][j]; // Make from 1st row in CSV
                      var model      = rows[1][j]; // Model from 2nd row in CSV
                      var makeModel  = rows[0][j] + " " + rows[1][j]; // Make + Model will serve as our key
                      var type       = rows[2][j]; // Type from 3rd row in CSV
                      var sales      = rows[i][j]; // Sales value for this vehicle and month

                      // If sales value exists...
                      if (sales) {
                        sales = parseInt(sales);
                      } else {
                        sales = 0;
                      }

                      dataset[i - 3][makeModel] = {
                        "make": make,
                        "model": model,
                        "type": type,
                        "sales": sales
                      };

                    }

                  }


                  var keys = Object.keys(dataset[0]).slice(1);

                  vehicleStack.keys(keys)
                       .value(function value(d, key) {
                         return d[key].sales;
                       });

                  var vehicleSeries = vehicleStack(dataset);

                  // TYPE DATA SERIES

                  typeDataset = [];

                  for (var i = 3; i < rows.length; i++) {

                    //Create new object
                    typeDataset[i - 3] = {
                      date: parseTime(rows[i][0]),
                      "HEV": 0,
                      "PHEV": 0,
                      "BEV": 0,
                      "FCEV": 0,
                    };

                    for (var j = 1; j < rows[i].length; j++) {

                      var type   = rows[2][j];
                      var sales  = rows[i][j];


                      if (sales) {
                        sales = parseInt(sales);
                      } else {
                        sales = 0;
                      }

                      typeDataset[i - 3][type] += sales;

                    }
                  }

                  typeStack.keys([ "HEV", "PHEV", "BEV", "FCEV" ]);

                  var typeSeries = typeStack(typeDataset);



                  // MAKE THE CHART

                  xScale = d3.scaleTime()
                             .domain([
                               d3.min(dataset, function(d) { return d.date; }),
                               d3.max(dataset, function(d) { return d.date; })
                             ])
                             .range([padding, w - padding * 2]);

                  yScale = d3.scaleLinear()
                             .domain([
                               0,
                               d3.max(dataset, function(d) {
                                 var sum = 0;


                                 //Loops once for each row, to calculate
                                 // the total (sum) of sales of all vehicles

                                 for (var i = 0; i < keys.length; i++) {
                                   sum += d[keys[i]].sales;
                                 };

                                 return sum;
                               })
                             ])
                             .range([h - padding, padding / 2])
                             .nice();

                  //Define axes
                  xAxis = d3.axisBottom()
                            .scale(xScale)
                            .ticks(10)
                            .tickFormat(formatTime);

                  yAxis = d3.axisRight()
                            .scale(yScale)
                            .ticks(5);

                  area  = d3.area()
                            .x(function(d) { return xScale(d.data.date); })
                            .y0(function(d) { return yScale(d[0]); })
                            .y1(function(d) { return yScale(d[1]); });

                  var svg = d3.select("body")
                              .append("svg")
                              .attr("width", w)
                              .attr("height", h);
                  
                  svg.append("g")
                    .attr("id", "vehicles")
                    .selectAll("path")
                    .data(vehicleSeries)
                    .enter()
                    .append("path")
                    .attr("class", "area")
                    .attr("d", area)
                    .attr("fill", function(d) {

                      var thisKey = d.key;

                      var thisType = d[0].data[thisKey].type;

                      var color;

                      switch (thisType) {
                        case "HEV":
                          color = d3.schemeCategory20[0];
                          break;
                        case "PHEV":
                          color = d3.schemeCategory20[1];
                          break;
                        case "BEV":
                          color = d3.schemeCategory20[2];
                          break;
                        case "FCEV":
                          color = d3.schemeCategory20[3];
                          break;
                        // default:
                        //   break;
                      }

                      return color;
                    })
                    .append("title")
                    .text(function(d) {
                      return d.key;
                    });


                    svg.append("g")
                      .attr("id", "types")
                      .selectAll("path")
                      .data(typeSeries)
                      .enter()
                      .append("path")
                      .attr("class", "area")
                      .attr("d", area)
                      .attr("fill", function(d) {

                        	//Which type is this?
                        var thisType = d.key;
                      
                        //New color var
                        var color;
                        
                        switch (thisType) {
                          case "HEV":
                            color = "rgb(110, 64, 170)";
                            break;
                          case "PHEV":
                            color = "rgb(76, 110, 219)";
                            break;
                          case "BEV":
                            color = "rgb(35, 171, 216)";
                            break;
                          case "FCEV":
                            color = "rgb(29, 223, 163)";
                            break;
                          // default:
                          //   break;
                        }
                        
                        return color;
                      })
                      .append("title")
                      .text(function(d) {
                        return d.key;
                      });

                    d3.select("g#types")
                      .on("click", function() {
                        d3.select(this)
                          .attr("opacity", 1)
                          .transition()
                          .duration(2000)
                          .attr("opacity", 0)
                      });

                    //Create axes
                    svg.append("g")
                      .attr("class", "axis x")
                      .attr("transform", "translate(0," + (h - padding) + ")")
                      .call(xAxis);
                  
                    svg.append("g")
                      .attr("class", "axis y")
                      .attr("transform", "translate(" + (w - padding * 2) + ",0)")
                      .call(yAxis);

                });
            </script>
        </body>
    </html>